include::../attribute.adoc[]


== GitHub 複数Org管理方針例
別紙参照

== GitHub 単一Org管理方針例

=== 権限管理方針
Organizationのメンバーを チーム に所属させ、 チーム 単位でリポジトリの権限を設定します。これにより、**煩雑な権限管理業務が軽減され、効率的な管理が可能**になります。個々のユーザにリポジトリ毎に異なる権限を設定することも出来ますが、煩雑な権限管理業務が発生し強い権限を付けたままになるなどのリスクがあります。効率的で作業漏れのしずらい運用を優先し **チーム単位での権限設定** とします。

そのため、原則としてアウトサイドコラボレータは利用しません。メンバーとして招待します。
アウトサイドコラボレータとして招待する場合は、プロジェクト管理者の責任において権限管理をおこないます。

たとえば、プロジェクトごとに管理者チーム、開発運用者チームを作成し、それぞれのチーム に対して権限を付与します。個人単位のでの権限付与は特別な事情が無い限り行いません。

==== チーム種別

管理に必要な権限を有する管理者チームと、プロジェクト毎の開発に必要な権限を有する開発運用者チームとします。管理者チームは常に１チームですが、開発運用者チームはプロジェクト毎に作成します。

GitHub 管理者チーム::
GitHubの全管理権限を有します。貴社社員の中でも特定のメンバーのみが加入します。

TIP: GitHub管理者チームを作成せずに、管理ユーザを共有するパターンもあります。

プロジェクト管理者チーム::
プロジェクトごとに作成します。
原則として、貴社社員のみが所属するチームです。これは、貴社の社員のみが所属することを意味します。プロジェクトの開発に必要な権限に加えて、プロジェクトの管理権限を有します。

プロジェクト開発運用者チーム::
プロジェクトごとに作成し、開発運用者が所属します。これは、他社もしくは個人が所属することを意味します。プロジェクト対象のリポジトリで開発できる権限を有します。管理権限が必要な場合は、申請承認を得て一時的に昇格し作業完了後に権限を剥奪します。

==== 権限管理

GitHubのロールは、Organizationとリポジトリで異なります。それぞれについて下記に記載します。

### Organization

Organizationや、Organizationのリポジトリ、Team、設定を管理してもらうために付与する権限のセットで、５つのロールが定義されています。管理者チームは `Owner` ロールを割り当て、開発運用者チームに `Member` ロールを割り当てます。

各ロールについては、 https://docs.github.com/ja/organizations/managing-peoples-access-to-your-organization-with-roles/roles-in-an-organization[公式リファレンス：Organizationのロール] を参照ください。

### Repository

チーム毎のリポジトリ権限は、GitHubのデフォルトロールを利用し権限を設定します。開発運用するなかで不十分な場合は、カスタムロールを作成することで対応します。
管理者チームは、リポジトリ毎の制限は行わず、すべてのリポジトリで `admin` ロールを割り当てます。開発運用者チームは、プロジェクト対象のリポジトリにのみ `write` ロールを割り当てます。

各ロールの詳細については、 https://docs.github.com/ja/organizations/managing-user-access-to-your-organizations-repositories/managing-repository-roles/repository-roles-for-an-organization[公式リファレンス：Organizationのリポジトリロール] を参照ください。

ファイルやディレクトリレベルでの細かい制御は、`CODEOWNERS` という機能でおこないます。

#### CODEOWNERS

`CODEOWNERS` は、ファイルやディレクトリレベルで所有者を設定できます。`CODEOWNERS` を設定しブランチプロテクションルールでブランチを保護することで、変更には `CODEOWNERS` の承認が必須となります。

設計ドキュメント、CIパイプラインに関連するファイルおよび、Environmentリポジトリの全ファイルを対象に管理者チームを `CODEOWNERS` に設定します。これにより、承認無く設計やパイプラインおよび、環境の変更が出来なくなります。

例えば、 `main` ブランチを保護し `docs` フォルダのファイル所有者を管理者チームを設定した場合、開発運用者チームは、 `main` ブランチを直接変更できなくなります。変更するためには、 `feature` ブランチで `docs` フォルダのファイルを変更し、 `main` ブランチへ向けたプルリクエストを出します。管理者チームがレビューし承認することで、 `main` ブランチへ反映可能となります。

`CODEOWNERS` の詳細については、 https://docs.github.com/ja/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners[公式リファレンス：コードオーナーについて] を参照ください。

==== 権限管理のFAQ

outside collaboratorとチーム招待の違い::
チームで管理できない。アカウント毎に設定が必要になり煩雑で反復的な作業が発生しやすい。
SSOできない。

=== リポジトリ管理方針

ポリレポと モノレポという大別して二つの考え方があるが、認知負荷の低さとパイプラインの保守運用性を優先し ポリレポ を採用します。 モノレポを採用することで、開発の容易性を向上させることもできますが、エコシステムの充実が不十分であり比較的高度なパイプラインの運用保守が必要となります。モノレポ は、固有の知識やスキルセットが必要となりますが、現時点(2023/10/19)では一般的な認知度はそれほど高くなく、経験者の獲得は難しく未経験者には学習が必要となります。

- ポリレポとは、ある一定粒度でリポジトリを分割して、複数のリポジトリで管理するアプローチ
- モノレポとは、複数のプロジェクトまたはシステムをまとめて、単一のリポジトリで管理するアプローチ

==== リポジトリトポロジー

本プロジェクトにおけるリポジトリの種類と包含関係を下図に示します。`Frontend Service Repository` と `Backend Service Repository` はリポジトリを分けます。
また、図中の各Repositoryは、単一のリポジトリでは無く分類を示しています。これは、`Backend Service Repository`など図中で緑色のリポジトリが複数存在することを示しています。

image::./repo-type.drawio.png[]

==== リポジトリ種別一覧

===== Application Repository
各種サービスやライブラリーリポジトリ群です。これらのリポジトリ群は、各種サービス、テスト、ビルドツール、コンテナ、CIパイプラインのコードやそれらの設定情報を有します。

Frontend Service Repository::
フロントエンド用のリポジトリ。パイプラインの最終成果物は、単一パッケージとなりバージョン管理します。

Backend Service Repository::
バックエンド用のリポジトリ。パイプラインの最終成果物は、単一コンテナとなりバージョン管理します。

(optional)Frontend Library Repository::
フロントエンドサービスが分割・新規作成された際に共通化したいライブラリのコードを管理するリポジトリ。パイプラインの最終成果物は、単一パッケージとなりバージョン管理され、フロントエンドサービスで利用します。

(optional)Backend Library Repository::
バックエンドサービスが分割・新規作成された際に共通化したいライブラリのコードを管理するリポジトリ。パイプラインの最終成果物は、単一ライブラリとなりバージョン管理され、バックエンドサービスで利用します。

(optional)Ops Optimize Service Repository::
開発運用業務を効率化したり、自動化するためのサービスのコードを管理するリポジトリ。パイプラインの最終成果物は、単一コンテナとなりバージョン管理します。

===== Environment Repository

環境情報やデプロイ、リリース設定を保持するリポジトリの総称。各環境ブランチへ変更が反映されることにより、自動的に当該環境の設定が変更します。

Infra Repository::

Azureなどのクラウドリソースの設定情報を有します。

(optional)Cluster Repository::

クラスタを利用する場合の選択肢となります。infraリポジトリ内で管理しても良いが、運用が難しい場合に利用します。Kubernetesなどのクラスタおよびそのコンテナの設定情報を有します。

===== Other Repository

`Application Repository` と `Environment Repository`に該当しないその他のリポジトリ群です。

Docs Repository::

プロジェクトの運営ルールや開発ルールや、リポジトリを跨る設計情報などのドキュメント配置先です。

Template Repository::

リポジトリを新規に作成する際の雛型になるリポジトリ。即座に開発を始めるためおよび、負の影響からリポジトリを保護するための初期設定やファイルを保持しています。

===== etc

全てのリポジトリに対して、共通的なテンプレートを提供できる `.github`などのメタリポジトリや、汎用的な用途のprojectリポジトリなど。

==== リポジトリ命名規約

`<プロジェクト識別子>-<固有名>-<種別>`

例）

* プロジェクト識別子が、 `ccp`
* 固有名が、feedback
* 種別が、Backend Service Repository

ccp-feedback-bs

==== Topics

それ以外のリポジトリを修飾する情報を付与します。

例)
言語など


== GitHub Copilot

=== 導入の狙い
* 生産性の向上が期待できる。他のプロジェクトで得た効果を中心に記載。
** フロントエンドの静的解析エラー解消が早くなる
** API 設計記載時の高効率なサジェスト
** エラー解消に掛かる時間の短縮
** terraform / azure など未経験領域で、サジェストを通じた高い学習効果（開発未経験者が開発に貢献できるレベル）
** etc...

=== 発生コスト
* 導入に掛かるコストはほぼゼロ
* 学習コストもほぼゼロ。使い始めから効果を発揮する類のソリューション
* １人当たりの月額　$19/month

=== 費用対効果
* 10-55%の生産性向上が期待できる。
* copilotを利用して開発者が作業時間を１時間程度短縮できればペイする。

=== 懸念事項
==== ライセンス権の侵害
ライセンス権の侵害リスクがある。生成されたコードが他者のライセンス権を侵害する可能性がある。

==== 機密情報の漏洩
開発中の情報を外部へ送信するため、機密情報の漏洩リスクがある。

==== セキュリティリスク
セキュリティリスクがある。脆弱性を含むコードが提案される可能性がある。

=== 懸念事項への対応
==== ライセンス権の侵害

 * 特定の設定をすることで、ライセンス侵害が発生した場合、賠償請求に対してGitHub社が無制限に補償
** https://github.com/customer-terms/github-copilot-product-specific-terms
** https://github.com/customer-terms/general-terms

==== 機密情報の漏洩リスク

 * 機密情報をリポジトリに含まないように運用している。開発環境の機密情報は開発者が知り得るが、本番環境は知りえない想定。
 * シークレットは、プリコミット＋パイプラインで混入を検出・ブロックしている。
 * 個人情報が含まれるデータは、機械的にマスキングされたもののみを利用可能とする。本番環境データ持ち出しは、マスキングされたものだけが対象となり、管理者承認なく持ち出せない。そのため、CodespacesやCopilotに混入することはない。

==== セキュリティリスク

 - 開発者が脆弱性を含まないコードを書かないとは限らない。
 - 開発者の目に必ず触れ、さらに実装者以外の１名以上のレビューが必須になっている。
 - 事前定義されたもののみではあるが、パイプラインで検査されている。

== GitHub Codespaces

=== https://docs.github.com/ja/codespaces/overview[概要]

https://docs.github.com/ja/codespaces/overview[GitHub Codespaces の概要]より引用

> codespace は、クラウドでホストされている開発環境です。 構成ファイルをリポジトリにコミットすることで、GitHub Codespaces のプロジェクトをカスタマイズできます (コードとしての構成とよく呼ばれます)。

Dev environments as code に分類されるVSCodeを主体としたCloud IDEです。開発環境の構成を宣言的にコードで記述でき、その環境を瞬時に起動し即座に開発を開始できます。単純な `web editor` ではなく、アプリケーションを起動しデバッグなども出来ます。web browser、localのVSCode、intellijから利用できます。

=== アーキテクチャ

image::./codespaces.drawio.png[]

=== 従来型のlocal IDEを利用して開発する場合との比較

==== メリット

* 開発運用者の開発環境構築コストが不要になる。cloneさえ不要になる。即座に開発を開始できる
* 準備・メンテナンスコストが軽減される。開発環境構築ガイド作成から開発環境をコードで宣言するに変わる。
* 開発環境が開発運用者の端末に依存しない。
** そもそも、開発環境を作る時の考慮事項が減る。
** トラブル発生頻度や解消に掛かる時間が減少する。
** 私の端末では動いたけど、動かないです？とかが無くなる。
* 開発環境を容易にスケールアップできる。
* 開発環境の構成変更を容易に開発運用者に適用できる。
* 開発環境が壊れてもすぐ元に戻る。開発環境を破壊しかねないチャレンジが容易になる。
* リモートでのペアプログラミングが容易。同時編集できる。
* パーソナルアクセストークンなどの発行や管理が不要。GitHub Codespaceは最初からリポジトリに紐づいておりコミットやプッシュができる。

==== デメリット

* 利用コストが発生する
** 費用対効果が見込めるか。
* 予想外のコスト発生しうる。
** さまざまな利用制限を設定可能。通知が来て上限値を上げることができる
* オフラインでweb browserで開発できない。
** ローカルにcloneしてvsocdeでコード書いて後でプッシュとかはできる。
* 開発運用者のネットワークが遅いと反応が鈍い。

=== ライセンスと費用感

==== VM

* 2core 4GB $0.18/hour
* __**4core 8GB $0.36/hour**__
* 8core 16GB $0.72/hour
* ・
* ・

==== ストレージ

$0.07 GB/month

==== 費用感

===== 前提条件

* １人当たりの稼働時間: 160 hour/month
* VM スペック: 4core 8GB $0.36/hour
* VM 利用比率: 80%
* ストレージ利用量: 100GB
* 開発運用者数: 10名

===== 算出値

* 月額 69,120円   (6,912 円/人)
* 年額 829,440円  (82,944 円/人)

==== 請求先と所有権

組織か個人のいずれかに設定できる。組織に設定することで請求がまとめて組織にくる。開発運用者は経費申請しなくていい。

* 組織に設定した場合は、請求がまとめて組織に行く。
* 個人を設定した場合は、請求が個人に行く。個人の場合は 60時間(2core/4GB)の無料枠がある。


==== 利用制限

* コンピューティング使用量とストレージ使用量を制限できる。
* マシンの種類を制限できる。リポジトリ毎に設定可能。
* アイドルタイムアウトで自動停止できる。デフォルト３０分。再起動は１分程度。
* ユーザ１人あたりのcodespaces数を制限できる。ストレージ料金の削減に役立つ。
* 未使用のcodespacesを自動削除できる。ストレージ料金の削減に役立つ。デフォルト３０日

#### 開発環境のその他の選択肢

* 無償のlocal IDEを利用する。
** VSCodeやeclipse
** GitHub Codespacesを利用する際のメリットが享受できない。
** 追加コストが掛からない。
* OSSのCloud IDEを自身で運用する
** Gitpodなどが使える自前のクラスタやサーバーで運用する。
** クラスタやサーバのインフラコストや運用コストに加えて、構築費用が発生する。
** 規模の経済が適用されるため、中・小規模開発には向かない。
* その他のSaaS
** AWS Cloud9
*** Nativeに統合されているGitHub Codespacesに機能面や利便性で劣る。
*** **リソース利用料は安い** が総合的には高い。アカウントやネットワーク周り含めて設計が別途発生し構築コストが掛かる。
** Gitpod Cloud
*** Nativeに統合されているGitHub Codespacesに機能面や利便性で劣る。
*** 費用はGitHub Codespacesとほぼ同じ


== Codespaces/Copilotデモ

