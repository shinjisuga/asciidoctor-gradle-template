include::../attribute.adoc[]

== トイルとの闘い方


=== トイルを知る

トイルとは、手作業、繰り返される、自動化が可能、戦術的、長期的な価値がない、サービスの成長に比例して増加する、といった特徴を持つ作業です

トイルと見なされるすべてのタスクがこれらすべての属性を備えているわけではありませんが、作業が次の説明の 1 つ以上に当てはまるほど、トイルである可能性が高くなります。

マニュアル::
これには、何らかのタスクを自動化するスクリプトを手動で実行するなどの作業が含まれます。スクリプトを実行する方が、スクリプト内の各ステップを手動で実行するよりも速いかもしれませんが、人間がそのスクリプトを実行するのに費やす実作業時間 (経過時間ではありません) は、依然として労力を要する時間です。

反復的::
初めて、あるいは 2 回目にタスクを実行する場合、この作業はトイルではありません。トイルとは、何度も繰り返す作業です。新しい問題を解決したり、新しい解決策を考案したりする場合、この作業はトイルではありません。

自動化可能::
機械が人間と同じように仕事をこなせる場合、あるいはその仕事の必要性を設計によって排除できる場合、その仕事はトイルである。その仕事に人間の判断が不可欠である場合、その仕事はトイルではない可能性が高い。

戦術::
トイルは、戦略主導でプロアクティブというよりは、割り込み主導でリアクティブです。アラートの処理はトイルです。この種の作業を完全になくすことはできないかもしれませんが、最小限に抑えるために継続的に取り組む必要があります。

永続的な価値がない::
タスクを完了した後もサービスが同じ状態のままである場合、そのタスクはおそらくトイルと言えます。タスクによってサービスが永続的に改善された場合、たとえレガシー コードや構成を調べて整理するなどの単調な作業が多少含まれていたとしても、それはトイルと言えません。

サービスの成長とともに直線的に増大する::
タスクに関連する作業がサービス サイズ、トラフィック量、またはユーザー数に応じて直線的に増加する場合、そのタスクはおそらくトイルです。理想的に管理および設計されたサービスは、リソースを追加するための 1 回限りの作業を除き、追加作業なしです。

==== トイルの例
- 割り当てリクエストの処理
- データベース スキーマ変更の適用
- 重要性の低いモニタリング アラートの確認
- プレイブックからのコマンドのコピーと貼り付け

==== 分析の仕方

* レベル1
** ヒアリング
* レベル2
** アンケート
* レベル3
** 機械的な計測とトラッキングルール整備

== トイルとの闘いを始める

=== ヒアリング
小さなテーブルでレベル１のヒアリングから始めましょう。
対象者にトイルが何かを説明したうえで、３つのトイルを教えてもらいましょう。

この段階では軽量ということにこだわってください。ここで几帳面になりすぎてもほとんど意味はありません。多数の詳細データの取得が必要となれば、むしろチームの負担が大きくなり、 **必要以上に細かく管理されていると感じさせ苦痛** になります。

ヒアリングによりいくつかの代表的なトイルが抽出されます。

=== グルーピング
以下の観点で作業をグルーピングします。

作業の種類:: （割り当ての変更、本番環境へのリリースの移行、ACL の更新など）

作業の難易度:: 容易（1 時間未満）、普通（数時間）、困難（数日）（経過時間ではなく実際の作業時間で判断）


=== ターゲットを決める

==== ファーストターゲット

自動化が容易そうで、作業の種類単位あたりの数が多いものを選ぶと効果的です。

作業の種類単位あたりの数が多い::
同じやり方で対応できる可能性があります。最初のやり方を考えるコストが高いですが、同じやり方で類似作業を減らすことは簡単です。

自動化が容易そう::
ほとんど行わないタスク（新しいロケーションへのサービスのデプロイなど）の自動化は難しい場合があります。

TIP: 自分たちのみならず、関係者が楽になるものを選ぶとより効果的ですが、チームを跨ぐコミュニケーションが発生し円滑に進まない可能性があります。

==== 施策の実施と効果ヒアリング
施策を実施し、効果をヒアリングします。

== 参考

- https://sre.google/sre-book/eliminating-toil/[トイルの削減]

- https://cloud.google.com/blog/ja/products/gcp/identifying-and-tracking-toil-using-sre-principles[SRE の原則に沿ったトイルの洗い出しとトラッキング]

=== ヒアリング内容の例


自動化できるのにそうしていないトイルがチーム内にありますか。ある場合は、トイルの内容と作業時間の概算値（４週間あたり）を教えてください::

自由回答


=== アンケート内容の例

どのくらいの時間をトイルに費やしましたか。全体に占めるおおよその割合を、過去 4 週間の平均値でお答えください。::
0～100%

トイルに費やした時間の長さについてどの程度満足していますか。::
非常に不満 / 普通 / まったく問題ない

トイルの発生源として多いものを 3 つ教えてください。::

オンコール対応 / 割り込み / プッシュ / 許容量 / その他

四半期目標に長期のエンジニアリング プロジェクトが含まれていますか。::

はい / いいえ

「はい」の場合、どのくらいの時間をエンジニアリング プロジェクトに費やしましたか。全体に占めるおおよその割合を、過去 4 週間の平均値でお答えください（概算値でかまいません）。::

0～100%

自動化のためのトイルに長期プロジェクトの作業時間を奪われるため、自動化できるのにそうしていないトイルがチーム内にありますか。ある場合は、トイルの内容と作業時間の概算値（４週間あたり）を教えてください::

自由回答

=== 機械的な算出とトラッキングルール例

トラッキングルール::
チケット作成時に作業種類ラベルを付ける。完了ステータスにする際に作業時間を入力する。（経過時間ではなく実際の作業に掛かった時間）

TIP: トラッキングは反発を受けやすくやりたがらない傾向にあるので、目的をしっかりと伝える。

機械的な算出（チケット）::
チケットの集計クエリ作成

機械的な算出（通知数）::
後続作業の無いアラートの発報数。

機械的な算出（コマンドの実行数）::
踏み台などのコマンド実行数をカウンティングする。

== 事例

=== プロジェクト概要

* 金融業
* プロダクションチームが利用する基盤開発
* スクラム開発
* 顧客＋ULS＋ベンダーの混成チーム
** サポートチームをEmbedded SREと呼んでいた。チームと言っても人がいなくて一人。立ち上げから参画。
** 本体が緑で、 Platform Engineering とSite Reliability Engineering 領域を兼務
** 二つのStream-alined teamsは、別のプロジェクト

image::team.drawio.png[]

=== 背景
* 金融ならではの権限分離や統制の強さにより、煩雑で反復的な作業が発生していた。
** 開発者は本番環境アカウントにログインできない
** 本番アクセスには申請承認・監査証跡の保管。キーボードのタイピング内容まで保管。
** マネコンからのリソース変更は原則できない。
** CUI操作のみ許容されている踏み台が存在し、申請承認を得て利用できる
** 踏み台は基本的に存在しておらず申請後に作成。終わったら権限破棄と合わせて踏み台も破棄。
** 本番データアクセスはさらに複雑な手続きが必要

> レトロスペクティブで何度も話題にあがるが、対処療法的な改善は限界だった。

=== ヒアリングワークショップ
* ホワイトボードにトイルを案出し
** 権限昇格申請に基づく一連の作業
** 持ち出し申請に基づく一連の作業
** アカウント払い出し
** 新規リポジトリ作成
* 最も時間が掛かる内容に投票
** ★権限昇格申請に基づく一連の作業★

=== 設計

image::before-architecture.drawio.png[]

[plantuml, diag-sequence, svg, pdfwidth=70%, width=70%]
[caption=""]
----
include::./puml/diag-sequence.puml[]
----

image::/workspaces/asciidoctor-gradle-template/docs/Chapter04/images/diag-sequence.svg[]

=== 効果測定
* ヒアリング
** 作業なくなった！

=== レトロスペクティブ
* 計測して継続的にやろう

=== 決まったこと
* 運用業務チケットにラベル付与ルール
** アラート対応の擬陽性判断
** 問い合わせ対応
** ユーザ追加・改廃
** 踏み台起動停止
** etc
* ラベルごとに平均時間を設定
* チケットの数で平均作業時間算出
* レトロスペクティブの冒頭
** ユーザ追加・改廃チケット20個 x 8 = 160分
** 踏み台起動停止チケット5 x 5 = 25分
** アラート対応の擬陽性判断 チケット5個 x 10分 = 50分
** 対応要否検討
* 同じスキームに乗るものから優先対応

=== アフター

image::after-architecture.drawio.png[]

* 他にやったこと
** GitHub の terraform化、コードオーナー設定、ブランチプロテクションルール
*** ユーザ、チームの追加・改廃は 申請者がプルリク出す
*** 基盤チームは承認
*** マージで反映
** 計測自体のダッシュボード化
*** クエリ書いてビュー設定
** etc

